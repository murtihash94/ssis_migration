<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Results - SSIS to Databricks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-database"></i> SSIS to Databricks Migration Tool
            </span>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="fas fa-home"></i> New Migration
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-check-circle text-success"></i> Migration Results</h2>
                    <div>
                        <a href="{{ url_for('download_results', session_id=session_id) }}" 
                           class="btn btn-primary">
                            <i class="fas fa-download"></i> Download All Results
                        </a>
                    </div>
                </div>
                <p class="text-muted">Session ID: {{ session_id }}</p>
            </div>
        </div>

        <!-- Summary Cards -->
        {% if results.sttm_count %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-sitemap fa-2x me-3"></i>
                            <div>
                                <h5 class="card-title mb-0">{{ results.sttm_count }}</h5>
                                <small>Mappings Generated</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-code fa-2x me-3"></i>
                            <div>
                                <h5 class="card-title mb-0">{{ results.generated_files|length }}</h5>
                                <small>Files Generated</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-database fa-2x me-3"></i>
                            <div>
                                <h5 class="card-title mb-0">Databricks</h5>
                                <small>Target Platform</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock fa-2x me-3"></i>
                            <div>
                                <h5 class="card-title mb-0">Complete</h5>
                                <small>Migration Status</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Tabbed Results -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="resultsTab" role="tablist">
                    {% if results.sttm %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="mappings-tab" data-bs-toggle="tab" 
                                data-bs-target="#mappings" type="button" role="tab">
                            <i class="fas fa-sitemap"></i> Source-Target Mappings
                        </button>
                    </li>
                    {% endif %}
                    {% if results.dlt_code %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="dlt-tab" data-bs-toggle="tab" 
                                data-bs-target="#dlt" type="button" role="tab">
                            <i class="fas fa-code"></i> DLT Pipeline
                        </button>
                    </li>
                    {% endif %}
                    {% if results.workflow_yaml %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="workflow-tab" data-bs-toggle="tab" 
                                data-bs-target="#workflow" type="button" role="tab">
                            <i class="fas fa-cogs"></i> Workflow
                        </button>
                    </li>
                    {% endif %}
                    {% if results.dag_data %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="dag-tab" data-bs-toggle="tab" 
                                data-bs-target="#dag" type="button" role="tab">
                            <i class="fas fa-sitemap"></i> Dependencies DAG
                        </button>
                    </li>
                    {% endif %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="files-tab" data-bs-toggle="tab" 
                                data-bs-target="#files" type="button" role="tab">
                            <i class="fas fa-folder"></i> Generated Files
                        </button>
                    </li>
                    {% if results.log %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="log-tab" data-bs-toggle="tab" 
                                data-bs-target="#log" type="button" role="tab">
                            <i class="fas fa-file-alt"></i> Migration Log
                        </button>
                    </li>
                    {% endif %}
                </ul>

                <div class="tab-content mt-3" id="resultsTabContent">
                    <!-- Mappings Tab -->
                    {% if results.sttm %}
                    <div class="tab-pane fade show active" id="mappings" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-sitemap"></i> Source-Target Mappings ({{ results.sttm_count }} mappings)</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    {{ results.sttm|safe }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- DLT Pipeline Tab -->
                    {% if results.dlt_code %}
                    <div class="tab-pane fade" id="dlt" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-code"></i> Generated DLT Pipeline</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('dlt-code')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <pre class="m-0"><code id="dlt-code" class="language-python">{{ results.dlt_code }}</code></pre>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Workflow Tab -->
                    {% if results.workflow_yaml %}
                    <div class="tab-pane fade" id="workflow" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-cogs"></i> Databricks Workflow Configuration</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('workflow-code')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <pre class="m-0"><code id="workflow-code" class="language-yaml">{{ results.workflow_yaml }}</code></pre>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- DAG Visualization Tab -->
                    {% if results.dag_data %}
                    <div class="tab-pane fade" id="dag" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-sitemap"></i> Dependencies DAG Visualization</h5>
                                <p class="mb-0 text-muted">Interactive visualization showing package dependencies and data flow relationships</p>
                            </div>
                            <div class="card-body">
                                <div id="dag-network" style="width: 100%; height: 600px; border: 1px solid #ccc; margin-bottom: 20px;"></div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-info-circle"></i> DAG Statistics</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <small class="text-muted">Total Nodes:</small>
                                                        <div class="fw-bold">{{ results.dag_data.stats.total_nodes }}</div>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted">Total Edges:</small>
                                                        <div class="fw-bold">{{ results.dag_data.stats.total_edges }}</div>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-12">
                                                        <small class="text-muted">Packages:</small>
                                                        <div class="fw-bold">{{ results.dag_data.stats.packages|length }}</div>
                                                    </div>
                                                </div>
                                                {% if results.dag_data.stats.node_types %}
                                                <div class="row mt-2">
                                                    <div class="col-12">
                                                        <small class="text-muted">Node Types:</small>
                                                        {% for node_type, count in results.dag_data.stats.node_types.items() %}
                                                        <span class="badge bg-secondary me-1">{{ node_type }}: {{ count }}</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-palette"></i> Legend</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-flex flex-wrap gap-2 mb-3">
                                                    <span class="badge" style="background-color: #4a90e2;">Package</span>
                                                    <span class="badge" style="background-color: #f39c12;">Data Flow</span>
                                                    <span class="badge" style="background-color: #27ae60;">Source</span>
                                                    <span class="badge" style="background-color: #e74c3c;">Destination</span>
                                                    <span class="badge" style="background-color: #3498db;">Transformation</span>
                                                </div>
                                                <div class="mt-2">
                                                    <small class="text-muted">Edge Types:</small>
                                                    <div class="d-flex flex-wrap gap-2">
                                                        <span class="badge" style="background-color: #2c3e50;">Control Flow</span>
                                                        <span class="badge" style="background-color: #e74c3c;">Data Flow</span>
                                                        <span class="badge" style="background-color: #8e44ad;">Package Dependency</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Generated Files Tab -->
                    <div class="tab-pane fade{% if not results.sttm %} show active{% endif %}" id="files" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-folder"></i> Generated Files ({{ results.generated_files|length }} files)</h5>
                            </div>
                            <div class="card-body">
                                {% if results.generated_files %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-file"></i> File Name</th>
                                                <th><i class="fas fa-folder-open"></i> Path</th>
                                                <th><i class="fas fa-weight-hanging"></i> Size</th>
                                                <th><i class="fas fa-download"></i> Download</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for file in results.generated_files %}
                                            <tr>
                                                <td>
                                                    <i class="fas fa-file-code text-primary"></i>
                                                    {{ file.name }}
                                                </td>
                                                <td><code>{{ file.path }}</code></td>
                                                <td>{{ "%.1f"|format(file.size / 1024) }} KB</td>
                                                <td>
                                                    <a href="{{ url_for('download_file', session_id=session_id, file_path=file.path) }}" 
                                                       class="btn btn-sm btn-primary">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="text-muted">No files generated.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Log Tab -->
                    {% if results.log %}
                    <div class="tab-pane fade" id="log" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-file-alt"></i> Migration Log</h5>
                            </div>
                            <div class="card-body">
                                <pre class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto;">{{ results.log }}</pre>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script>
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.innerText;
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied';
                button.classList.add('btn-success');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                }, 2000);
            });
        }

        // DAG Visualization
        {% if results.dag_data %}
        let dagNetwork = null;
        
        function initDAGVisualization() {
            // DAG data from server
            const dagData = {{ results.dag_data | tojson }};
            
            // Create network
            const nodes = new vis.DataSet(dagData.nodes);
            const edges = new vis.DataSet(dagData.edges);
            
            const container = document.getElementById('dag-network');
            const data = { nodes: nodes, edges: edges };
            const options = {
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD',
                        sortMethod: 'directed',
                        nodeSpacing: 150,
                        levelSeparation: 100
                    }
                },
                physics: {
                    hierarchicalRepulsion: {
                        centralGravity: 0.3,
                        springLength: 100,
                        springConstant: 0.01,
                        nodeDistance: 120,
                        damping: 0.09
                    },
                    maxVelocity: 50,
                    solver: 'hierarchicalRepulsion',
                    timestep: 0.35,
                    stabilization: {iterations: 150}
                },
                nodes: {
                    font: {
                        size: 12,
                        color: '#000000'
                    },
                    margin: 10,
                    borderWidth: 2,
                    shadow: true,
                    chosen: {
                        node: function(values, id, selected, hovering) {
                            values.shadowColor = '#2c3e50';
                            values.shadowSize = 10;
                        }
                    }
                },
                edges: {
                    font: {
                        size: 10,
                        align: 'middle'
                    },
                    arrows: {
                        to: {
                            enabled: true,
                            scaleFactor: 0.8
                        }
                    },
                    smooth: {
                        type: 'cubicBezier',
                        forceDirection: 'vertical',
                        roundness: 0.4
                    },
                    chosen: {
                        edge: function(values, id, selected, hovering) {
                            values.width = values.width * 2;
                        }
                    }
                },
                interaction: {
                    dragNodes: true,
                    dragView: true,
                    zoomView: true,
                    selectConnectedEdges: true,
                    hover: true,
                    tooltipDelay: 200
                }
            };
            
            dagNetwork = new vis.Network(container, data, options);
            
            // Add event listeners
            dagNetwork.on('selectNode', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = nodes.get(nodeId);
                    console.log('Selected node:', node);
                    
                    // Show node details (optional)
                    showNodeDetails(node);
                }
            });
            
            dagNetwork.on('hoverNode', function(params) {
                const nodeId = params.node;
                const node = nodes.get(nodeId);
                // Could add custom tooltip here
            });
            
            dagNetwork.on('selectEdge', function(params) {
                if (params.edges.length > 0) {
                    const edgeId = params.edges[0];
                    const edge = edges.get(edgeId);
                    console.log('Selected edge:', edge);
                }
            });
        }
        
        function showNodeDetails(node) {
            // Could show a modal or tooltip with node details
            let details = `Node: ${node.label}\\nType: ${node.type}`;
            if (node.creation_name) {
                details += `\\nCreation: ${node.creation_name}`;
            }
            if (node.package) {
                details += `\\nPackage: ${node.package}`;
            }
            // For now, just log to console
            console.log(details);
        }
        
        // Initialize DAG when the tab is shown
        document.addEventListener('shown.bs.tab', function (e) {
            if (e.target.id === 'dag-tab' && dagNetwork === null) {
                setTimeout(initDAGVisualization, 100); // Small delay to ensure DOM is ready
            }
        });
        
        // Also initialize if DAG tab is active by default
        document.addEventListener('DOMContentLoaded', function() {
            const dagTab = document.getElementById('dag-tab');
            if (dagTab && dagTab.classList.contains('active')) {
                setTimeout(initDAGVisualization, 100);
            }
        });
        {% endif %}
    </script>
</body>
</html>