<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Results - SSIS to Databricks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-database"></i> SSIS to Databricks Migration Tool
            </span>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="fas fa-home"></i> New Migration
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-check-circle text-success"></i> Migration Results</h2>
                    <div>
                        <a href="{{ url_for('download_results', session_id=session_id) }}" 
                           class="btn btn-primary">
                            <i class="fas fa-download"></i> Download All Results
                        </a>
                    </div>
                </div>
                <p class="text-muted">Session ID: {{ session_id }}</p>
            </div>
        </div>

        <!-- Summary Cards -->
        {% if results.sttm_count %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-sitemap fa-2x me-3"></i>
                            <div>
                                <h5 class="card-title mb-0">{{ results.sttm_count }}</h5>
                                <small>Mappings Generated</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-code fa-2x me-3"></i>
                            <div>
                                <h5 class="card-title mb-0">{{ results.generated_files|length }}</h5>
                                <small>Files Generated</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-database fa-2x me-3"></i>
                            <div>
                                <h5 class="card-title mb-0">Databricks</h5>
                                <small>Target Platform</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock fa-2x me-3"></i>
                            <div>
                                <h5 class="card-title mb-0">Complete</h5>
                                <small>Migration Status</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Tabbed Results -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="resultsTab" role="tablist">
                    {% if results.sttm %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="mappings-tab" data-bs-toggle="tab" 
                                data-bs-target="#mappings" type="button" role="tab">
                            <i class="fas fa-sitemap"></i> Source-Target Mappings
                        </button>
                    </li>
                    {% endif %}
                    {% if results.dlt_code %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="dlt-tab" data-bs-toggle="tab" 
                                data-bs-target="#dlt" type="button" role="tab">
                            <i class="fas fa-code"></i> DLT Pipeline
                        </button>
                    </li>
                    {% endif %}
                    {% if results.workflow_yaml %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="workflow-tab" data-bs-toggle="tab" 
                                data-bs-target="#workflow" type="button" role="tab">
                            <i class="fas fa-cogs"></i> Workflow
                        </button>
                    </li>
                    {% endif %}
                    {% if results.dag_data %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="dag-tab" data-bs-toggle="tab" 
                                data-bs-target="#dag" type="button" role="tab">
                            <i class="fas fa-sitemap"></i> Dependencies DAG
                        </button>
                    </li>
                    {% endif %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="files-tab" data-bs-toggle="tab" 
                                data-bs-target="#files" type="button" role="tab">
                            <i class="fas fa-folder"></i> Generated Files
                        </button>
                    </li>
                    {% if results.log %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="log-tab" data-bs-toggle="tab" 
                                data-bs-target="#log" type="button" role="tab">
                            <i class="fas fa-file-alt"></i> Migration Log
                        </button>
                    </li>
                    {% endif %}
                </ul>

                <div class="tab-content mt-3" id="resultsTabContent">
                    <!-- Mappings Tab -->
                    {% if results.sttm %}
                    <div class="tab-pane fade show active" id="mappings" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-sitemap"></i> Source-Target Mappings ({{ results.sttm_count }} mappings)</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    {{ results.sttm|safe }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- DLT Pipeline Tab -->
                    {% if results.dlt_code %}
                    <div class="tab-pane fade" id="dlt" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-code"></i> Generated DLT Pipeline</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('dlt-code')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <pre class="m-0"><code id="dlt-code" class="language-python">{{ results.dlt_code }}</code></pre>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Workflow Tab -->
                    {% if results.workflow_yaml %}
                    <div class="tab-pane fade" id="workflow" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-cogs"></i> Databricks Workflow Configuration</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('workflow-code')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <pre class="m-0"><code id="workflow-code" class="language-yaml">{{ results.workflow_yaml }}</code></pre>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- DAG Visualization Tab -->
                    {% if results.dag_data %}
                    <div class="tab-pane fade" id="dag" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-sitemap"></i> Dependencies DAG Visualization</h5>
                                <p class="mb-0 text-muted">Interactive visualization showing package dependencies and data flow relationships</p>
                            </div>
                            <div class="card-body">
                                <!-- DAG Control Panel -->
                                <div class="dag-controls mb-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="btn-group" role="group" aria-label="DAG Views">
                                                <button type="button" class="btn btn-outline-primary active" id="dag-full-view" onclick="showDAGView('full')">
                                                    <i class="fas fa-sitemap"></i> Full View
                                                </button>
                                                <button type="button" class="btn btn-outline-primary" id="dag-packages-view" onclick="showDAGView('packages')">
                                                    <i class="fas fa-boxes"></i> Packages Only
                                                </button>
                                                <button type="button" class="btn btn-outline-primary" id="dag-dataflows-view" onclick="showDAGView('dataflows')">
                                                    <i class="fas fa-stream"></i> Data Flows
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="btn-group float-end" role="group" aria-label="DAG Controls">
                                                <button type="button" class="btn btn-outline-secondary" onclick="fitDAGNetwork()">
                                                    <i class="fas fa-expand-arrows-alt"></i> Fit
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="resetDAGZoom()">
                                                    <i class="fas fa-search-minus"></i> Reset Zoom
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="stabilizeDAGNetwork()">
                                                    <i class="fas fa-sync"></i> Stabilize
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Filter Controls -->
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <label for="package-filter" class="form-label">Filter by Package:</label>
                                            <select class="form-select form-select-sm" id="package-filter" onchange="filterDAGByPackage()">
                                                <option value="">All Packages</option>
                                                {% for package in results.dag_data.stats.packages %}
                                                <option value="{{ package }}">{{ package }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="node-type-filter" class="form-label">Filter by Node Type:</label>
                                            <select class="form-select form-select-sm" id="node-type-filter" onchange="filterDAGByNodeType()">
                                                <option value="">All Types</option>
                                                {% for node_type, count in results.dag_data.stats.node_types.items() %}
                                                <option value="{{ node_type }}">{{ node_type|title }} ({{ count }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="dag-network" style="width: 100%; height: 700px; border: 1px solid #ccc; margin-bottom: 20px; border-radius: 8px;">
                    <div id="dag-fallback" style="display: none; text-align: center; padding: 50px; background: #f8f9fa; border-radius: 8px;">
                        <h5>DAG Visualization Loading...</h5>
                        <p class="text-muted">If the visualization doesn't load, external libraries may be blocked.</p>
                        <p><strong>Alternative:</strong> Download the <a href="/download/{{ session_id }}/dag/dag_visualization.html" class="btn btn-sm btn-primary">DAG HTML File</a> to view locally.</p>
                    </div>
                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-info-circle"></i> DAG Statistics</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <small class="text-muted">Total Nodes:</small>
                                                        <div class="fw-bold">{{ results.dag_data.stats.total_nodes }}</div>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted">Total Edges:</small>
                                                        <div class="fw-bold">{{ results.dag_data.stats.total_edges }}</div>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-12">
                                                        <small class="text-muted">Packages:</small>
                                                        <div class="fw-bold">{{ results.dag_data.stats.packages|length }}</div>
                                                    </div>
                                                </div>
                                                {% if results.dag_data.stats.node_types %}
                                                <div class="row mt-2">
                                                    <div class="col-12">
                                                        <small class="text-muted">Node Types:</small>
                                                        {% for node_type, count in results.dag_data.stats.node_types.items() %}
                                                        <span class="badge bg-secondary me-1">{{ node_type }}: {{ count }}</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-palette"></i> Legend</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-flex flex-wrap gap-2 mb-3">
                                                    <span class="badge" style="background-color: #4a90e2;">Package</span>
                                                    <span class="badge" style="background-color: #f39c12;">Data Flow</span>
                                                    <span class="badge" style="background-color: #27ae60;">Source</span>
                                                    <span class="badge" style="background-color: #e74c3c;">Destination</span>
                                                    <span class="badge" style="background-color: #3498db;">Transformation</span>
                                                </div>
                                                <div class="mt-2">
                                                    <small class="text-muted">Edge Types:</small>
                                                    <div class="d-flex flex-wrap gap-2">
                                                        <span class="badge" style="background-color: #2c3e50;">Control Flow</span>
                                                        <span class="badge" style="background-color: #e74c3c;">Data Flow</span>
                                                        <span class="badge" style="background-color: #8e44ad;">Package Dependency</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Generated Files Tab -->
                    <div class="tab-pane fade{% if not results.sttm %} show active{% endif %}" id="files" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-folder"></i> Generated Files ({{ results.generated_files|length }} files)</h5>
                            </div>
                            <div class="card-body">
                                {% if results.generated_files %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-file"></i> File Name</th>
                                                <th><i class="fas fa-folder-open"></i> Path</th>
                                                <th><i class="fas fa-weight-hanging"></i> Size</th>
                                                <th><i class="fas fa-download"></i> Download</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for file in results.generated_files %}
                                            <tr>
                                                <td>
                                                    <i class="fas fa-file-code text-primary"></i>
                                                    {{ file.name }}
                                                </td>
                                                <td><code>{{ file.path }}</code></td>
                                                <td>{{ "%.1f"|format(file.size / 1024) }} KB</td>
                                                <td>
                                                    <a href="{{ url_for('download_file', session_id=session_id, file_path=file.path) }}" 
                                                       class="btn btn-sm btn-primary">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="text-muted">No files generated.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Log Tab -->
                    {% if results.log %}
                    <div class="tab-pane fade" id="log" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-file-alt"></i> Migration Log</h5>
                            </div>
                            <div class="card-body">
                                <pre class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto;">{{ results.log }}</pre>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script>
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.innerText;
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied';
                button.classList.add('btn-success');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                }, 2000);
            });
        }

        // DAG Visualization
        {% if results.dag_data %}
        let dagNetwork = null;
        
        function initDAGVisualization() {
            if (dagNetwork !== null) return; // Already initialized
            
            // DAG data from server
            const dagData = {{ results.dag_data | tojson }};
            
            // Create network datasets
            const allNodes = new vis.DataSet(dagData.nodes);
            const allEdges = new vis.DataSet(dagData.edges);
            
            // Current filtered datasets
            window.dagNodes = new vis.DataSet(dagData.nodes);
            window.dagEdges = new vis.DataSet(dagData.edges);
            
            // Store original data for filtering
            window.originalDAGData = {
                nodes: dagData.nodes,
                edges: dagData.edges
            };
            
            const container = document.getElementById('dag-network');
            const data = { nodes: window.dagNodes, edges: window.dagEdges };
            
            // Calculate dynamic spacing based on graph complexity
            const nodeCount = dagData.nodes.length;
            const dynamicNodeSpacing = Math.max(200, Math.min(400, nodeCount * 8));
            const dynamicLevelSeparation = Math.max(150, Math.min(300, nodeCount * 6));
            
            const options = {
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD',
                        sortMethod: 'directed',
                        nodeSpacing: dynamicNodeSpacing,
                        levelSeparation: dynamicLevelSeparation,
                        shakeTowards: 'roots'
                    }
                },
                physics: {
                    hierarchicalRepulsion: {
                        centralGravity: 0.2,
                        springLength: 150,
                        springConstant: 0.005,
                        nodeDistance: 180,
                        damping: 0.15
                    },
                    maxVelocity: 30,
                    solver: 'hierarchicalRepulsion',
                    timestep: 0.5,
                    stabilization: {
                        iterations: 200,
                        updateInterval: 25
                    }
                },
                nodes: {
                    font: {
                        size: 16,
                        color: '#2c3e50',
                        face: 'Arial, sans-serif',
                        background: 'rgba(255,255,255,0.8)',
                        strokeWidth: 1,
                        strokeColor: '#ffffff'
                    },
                    margin: {
                        top: 10,
                        right: 15,
                        bottom: 10,
                        left: 15
                    },
                    borderWidth: 3,
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.2)',
                        size: 8,
                        x: 2,
                        y: 2
                    },
                    chosen: {
                        node: function(values, id, selected, hovering) {
                            values.shadowColor = '#3498db';
                            values.shadowSize = 15;
                            values.borderWidth = 4;
                        }
                    },
                    scaling: {
                        min: 15,
                        max: 35,
                        label: {
                            enabled: true,
                            min: 14,
                            max: 20,
                            maxVisible: 25,
                            drawThreshold: 8
                        }
                    }
                },
                edges: {
                    font: {
                        size: 12,
                        align: 'middle',
                        color: '#2c3e50',
                        background: 'rgba(255,255,255,0.8)',
                        strokeWidth: 1,
                        strokeColor: '#ffffff'
                    },
                    arrows: {
                        to: {
                            enabled: true,
                            scaleFactor: 1.2,
                            type: 'arrow'
                        }
                    },
                    smooth: {
                        type: 'cubicBezier',
                        forceDirection: 'vertical',
                        roundness: 0.6
                    },
                    chosen: {
                        edge: function(values, id, selected, hovering) {
                            values.width = values.width * 2;
                            values.color = '#3498db';
                        }
                    },
                    scaling: {
                        min: 1,
                        max: 8
                    }
                },
                interaction: {
                    dragNodes: true,
                    dragView: true,
                    zoomView: true,
                    selectConnectedEdges: true,
                    hover: true,
                    tooltipDelay: 150,
                    zoomSpeed: 1
                }
            };
            
            dagNetwork = new vis.Network(container, data, options);
            
            // Add enhanced event listeners
            dagNetwork.on('selectNode', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = window.dagNodes.get(nodeId);
                    console.log('Selected node:', node);
                    
                    // Show enhanced node details
                    showEnhancedNodeDetails(node);
                }
            });
            
            dagNetwork.on('hoverNode', function(params) {
                const nodeId = params.node;
                const node = window.dagNodes.get(nodeId);
                
                // Create custom tooltip
                showNodeTooltip(node, params.pointer.DOM);
            });
            
            dagNetwork.on('blurNode', function(params) {
                hideNodeTooltip();
            });
            
            dagNetwork.on('selectEdge', function(params) {
                if (params.edges.length > 0) {
                    const edgeId = params.edges[0];
                    const edge = window.dagEdges.get(edgeId);
                    console.log('Selected edge:', edge);
                    showEdgeDetails(edge);
                }
            });
            
            // Auto-fit after stabilization
            dagNetwork.once("stabilizationIterationsDone", function () {
                dagNetwork.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: "easeInOutQuad"
                    }
                });
            });
        }
        
        // Enhanced node details function
        function showEnhancedNodeDetails(node) {
            const detailsPanel = document.getElementById('node-details-panel');
            if (!detailsPanel) {
                // Create details panel if it doesn't exist
                const panel = document.createElement('div');
                panel.id = 'node-details-panel';
                panel.className = 'alert alert-info';
                panel.style.position = 'fixed';
                panel.style.top = '20px';
                panel.style.right = '20px';
                panel.style.maxWidth = '300px';
                panel.style.zIndex = '1000';
                document.body.appendChild(panel);
            }
            
            let details = `<strong>${node.label}</strong><br>`;
            details += `<small class="text-muted">Type: ${node.type}</small><br>`;
            
            if (node.creation_name) {
                details += `<small>Creation: ${node.creation_name}</small><br>`;
            }
            if (node.package) {
                details += `<small>Package: ${node.package}</small><br>`;
            }
            if (node.data_flow) {
                details += `<small>Data Flow: ${node.data_flow}</small><br>`;
            }
            if (node.component_class) {
                details += `<small>Component: ${node.component_class}</small><br>`;
            }
            
            details += `<button class="btn btn-sm btn-secondary mt-2" onclick="document.getElementById('node-details-panel').remove()">Close</button>`;
            
            document.getElementById('node-details-panel').innerHTML = details;
        }
        
        // Tooltip functions
        function showNodeTooltip(node, position) {
            hideNodeTooltip(); // Remove any existing tooltip
            
            const tooltip = document.createElement('div');
            tooltip.id = 'dag-tooltip';
            tooltip.className = 'dag-tooltip';
            tooltip.innerHTML = `
                <strong>${node.label}</strong><br>
                <small>Type: ${node.type}</small>
                ${node.package ? `<br><small>Package: ${node.package}</small>` : ''}
            `;
            
            tooltip.style.position = 'absolute';
            tooltip.style.left = (position.x + 10) + 'px';
            tooltip.style.top = (position.y - 10) + 'px';
            tooltip.style.background = 'rgba(0,0,0,0.8)';
            tooltip.style.color = 'white';
            tooltip.style.padding = '8px 12px';
            tooltip.style.borderRadius = '4px';
            tooltip.style.fontSize = '12px';
            tooltip.style.zIndex = '1000';
            tooltip.style.pointerEvents = 'none';
            
            document.body.appendChild(tooltip);
        }
        
        function hideNodeTooltip() {
            const tooltip = document.getElementById('dag-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
        }
        
        function showEdgeDetails(edge) {
            console.log('Edge details:', edge);
            // Could enhance this with a modal or side panel
        }
        
        // DAG View Control Functions
        function showDAGView(viewType) {
            // Update button states
            document.querySelectorAll('[id^="dag-"][id$="-view"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`dag-${viewType}-view`).classList.add('active');
            
            const originalData = window.originalDAGData;
            let filteredNodes = [];
            let filteredEdges = [];
            
            switch(viewType) {
                case 'packages':
                    filteredNodes = originalData.nodes.filter(node => 
                        node.type === 'package' || node.type === 'executable'
                    );
                    filteredEdges = originalData.edges.filter(edge => {
                        const nodeIds = filteredNodes.map(n => n.id);
                        return nodeIds.includes(edge.from) && nodeIds.includes(edge.to);
                    });
                    break;
                    
                case 'dataflows':
                    filteredNodes = originalData.nodes.filter(node => 
                        node.type === 'data_flow' || node.type === 'component'
                    );
                    filteredEdges = originalData.edges.filter(edge => {
                        const nodeIds = filteredNodes.map(n => n.id);
                        return nodeIds.includes(edge.from) && nodeIds.includes(edge.to);
                    });
                    break;
                    
                default: // full
                    filteredNodes = originalData.nodes;
                    filteredEdges = originalData.edges;
            }
            
            // Update the network
            window.dagNodes.clear();
            window.dagEdges.clear();
            window.dagNodes.add(filteredNodes);
            window.dagEdges.add(filteredEdges);
            
            // Re-stabilize
            dagNetwork.stabilize();
        }
        
        // Filter Functions
        function filterDAGByPackage() {
            const selectedPackage = document.getElementById('package-filter').value;
            const originalData = window.originalDAGData;
            
            let filteredNodes = originalData.nodes;
            let filteredEdges = originalData.edges;
            
            if (selectedPackage) {
                filteredNodes = originalData.nodes.filter(node => 
                    node.package === selectedPackage || node.type === 'package'
                );
                filteredEdges = originalData.edges.filter(edge => {
                    const nodeIds = filteredNodes.map(n => n.id);
                    return nodeIds.includes(edge.from) && nodeIds.includes(edge.to);
                });
            }
            
            window.dagNodes.clear();
            window.dagEdges.clear();
            window.dagNodes.add(filteredNodes);
            window.dagEdges.add(filteredEdges);
            
            dagNetwork.stabilize();
        }
        
        function filterDAGByNodeType() {
            const selectedType = document.getElementById('node-type-filter').value;
            const originalData = window.originalDAGData;
            
            let filteredNodes = originalData.nodes;
            let filteredEdges = originalData.edges;
            
            if (selectedType) {
                filteredNodes = originalData.nodes.filter(node => 
                    node.type === selectedType
                );
                filteredEdges = originalData.edges.filter(edge => {
                    const nodeIds = filteredNodes.map(n => n.id);
                    return nodeIds.includes(edge.from) && nodeIds.includes(edge.to);
                });
            }
            
            window.dagNodes.clear();
            window.dagEdges.clear();
            window.dagNodes.add(filteredNodes);
            window.dagEdges.add(filteredEdges);
            
            dagNetwork.stabilize();
        }
        
        // Control Functions
        function fitDAGNetwork() {
            if (dagNetwork) {
                dagNetwork.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: "easeInOutQuad"
                    }
                });
            }
        }
        
        function resetDAGZoom() {
            if (dagNetwork) {
                dagNetwork.moveTo({
                    position: {x: 0, y: 0},
                    scale: 1,
                    animation: {
                        duration: 1000,
                        easingFunction: "easeInOutQuad"
                    }
                });
            }
        }
        
        function stabilizeDAGNetwork() {
            if (dagNetwork) {
                dagNetwork.stabilize();
            }
        }
        
        // Initialize DAG when the tab is shown
        document.addEventListener('shown.bs.tab', function (e) {
            if (e.target.id === 'dag-tab' && dagNetwork === null) {
                setTimeout(initDAGVisualization, 100); // Small delay to ensure DOM is ready
                // Show fallback if vis.js doesn't load within 3 seconds
                setTimeout(function() {
                    if (dagNetwork === null && document.getElementById('dag-network')) {
                        document.getElementById('dag-fallback').style.display = 'block';
                    }
                }, 3000);
            }
        });
        
        // Also initialize if DAG tab is active by default
        document.addEventListener('DOMContentLoaded', function() {
            const dagTab = document.getElementById('dag-tab');
            if (dagTab && dagTab.classList.contains('active')) {
                setTimeout(initDAGVisualization, 100);
                // Show fallback if vis.js doesn't load within 3 seconds
                setTimeout(function() {
                    if (dagNetwork === null && document.getElementById('dag-network')) {
                        document.getElementById('dag-fallback').style.display = 'block';
                    }
                }, 3000);
            }
        });
        {% endif %}
    </script>
</body>
</html>